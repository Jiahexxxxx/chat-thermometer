<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŠå¤©æº«åº¦è¨ˆï¼ˆå…è²»å®Œæ•´ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0f172a; --card:#020617; --text:#e5e7eb; --muted:rgba(229,231,235,.78);
      --line:rgba(255,255,255,.10); --box:#0b1220; --btn:#38bdf8; --btnText:#062235;
      --ok:#34d399; --danger:#fb7185;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif;
      display:flex; justify-content:center; padding:22px 14px;
    }
    .card{
      width:100%; max-width:680px; background:var(--card); border-radius:16px; padding:18px;
      border:1px solid var(--line); box-shadow:0 20px 40px rgba(0,0,0,.45);
    }
    h1{margin:0 0 6px; text-align:center; font-size:20px;}
    .sub{margin:0 0 12px; text-align:center; color:var(--muted); font-size:13px; line-height:1.45;}
    .row{margin-top:10px;}
    input[type="file"], textarea, select{
      width:100%; border-radius:12px; border:1px solid var(--line);
      background:var(--box); color:var(--text);
    }
    input[type="file"]{padding:10px;}
    textarea{height:150px; padding:10px; resize:none; outline:none; font-size:14px; line-height:1.4;}
    select{padding:10px;}
    .tiny{font-size:12px; color:var(--muted); line-height:1.45; margin-top:6px;}
    .preview{
      margin-top:10px; padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--box);
      display:none;
    }
    .preview img{width:100%; border-radius:10px; display:block;}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:14px 0;}
    button{
      width:100%; margin-top:10px; padding:12px 14px; border:none; border-radius:999px;
      background:var(--btn); color:var(--btnText); font-weight:900; font-size:16px; cursor:pointer;
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    .ghostBtn{
      background:transparent; color:var(--text); border:1px solid var(--line);
      font-weight:800; font-size:14px;
    }
    .dangerBtn{ background:var(--danger); color:#1b0b10; }
    .status{
      margin-top:10px; padding:10px; border-radius:12px;
      background:rgba(56,189,248,.10); border:1px solid rgba(56,189,248,.25);
      font-size:13px; line-height:1.5;
    }
    .result{
      margin-top:12px; text-align:center; font-size:18px; font-weight:900; min-height:28px;
    }
    .hint{
      margin-top:10px; color:var(--muted); font-size:12px; line-height:1.55; white-space:pre-wrap;
    }
    .timeWrap{
      margin-top:10px; padding:12px; border-radius:12px; background:var(--box); border:1px solid var(--line);
    }
    .timeBtns{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .timeBtn{
      padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03); color:var(--text); font-weight:800; font-size:14px; cursor:pointer;
    }
    .timeBtn.picked{background:var(--ok); color:#022c22; border-color:rgba(52,211,153,.65);}
    canvas{
      width:100%; height:auto; margin-top:10px; border-radius:12px; border:1px solid var(--line); background:var(--box);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>èŠå¤©æº«åº¦è¨ˆï¼ˆå…è²»å®Œæ•´ç‰ˆï¼‰</h1>
    <div class="sub">
      âœ… å¤šå¼µæˆªåœ– OCR è®€å­—ï½œâœ… ç„¡é™ç´¯ç©ï¼ˆå­˜åœ¨æœ¬æ©Ÿï¼‰ï½œâœ… ç³»çµ±è‡ªå‹•æ¨å®šå›è¦†æ™‚é–“<br>
      âœ… ç›´æ¥æ•™ä½ æ€éº¼å›ï¼ˆå¯è¤‡è£½ï¼‰ï½œï¼ˆå¯é¸ï¼‰é»å…©å€‹æ™‚é–“ä¿®æ­£ï¼šä½ ç™¼ â†’ å¥¹å›
    </div>

    <div class="row">
      <input id="image" type="file" accept="image/*" multiple />
      <div class="tiny">å»ºè­°ï¼šç”¨èŠå¤©æˆªåœ–ã€è£åˆ‡åªç•™å°è©±å€ã€å­—è¶Šæ¸…æ¥šè¶Šæº–ã€‚</div>
    </div>

    <div class="preview" id="previewWrap">
      <img id="preview" alt="é è¦½åœ–ç‰‡" />
    </div>

    <div class="row">
      <div class="tiny">ï¼ˆå¯é¸ï¼‰ä½ ä¹Ÿå¯ä»¥åœ¨é€™è£¡è£œå…… / ä¿®æ­£æ–‡å­—ï¼ˆæœƒåŠ åˆ°ç´¯ç©å°è©±æœ€å¾Œé¢ï¼‰ï¼š</div>
      <textarea id="chat" placeholder="è²¼ä¸Šæ–‡å­—æˆ–è£œå……ï¼šä¾‹å¦‚ã€å¥¹å›å¾ˆæ…¢é‚„è¦èŠå—ã€"></textarea>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="tiny">ğŸ“š æœ¬æ©Ÿç´¯ç©ç´€éŒ„</div>
      <div class="status" id="historyBox" style="display:block"></div>
      <button id="clearBtn" class="dangerBtn" type="button">æ¸…é™¤æœ¬æ©Ÿå°è©±èˆ‡å›è¦†ç´€éŒ„</button>
      <button id="exportBtn" class="ghostBtn" type="button">ä¸‹è¼‰ç´€éŒ„ï¼ˆJSONï¼‰</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="tiny">â±ï¸ å›è¦†æ™‚é–“ï¼ˆç³»çµ±è‡ªå‹•æ¨å®šï¼›ä½ è¦ºå¾—ä¸æº–å†æ‰‹å‹•ä¿®æ­£ï¼‰</div>
      <div class="timeWrap">
        <div class="tiny" style="margin-bottom:6px;">
          ä¾†æºï¼š
          <select id="appMode" style="width:auto;display:inline-block;">
            <option value="auto">è‡ªå‹•ï¼ˆå»ºè­°ï¼‰</option>
            <option value="line">LINE</option>
            <option value="ig">IG</option>
          </select>
        </div>

        <div id="timeGuide" class="tiny">ä¸Šå‚³æˆªåœ–ä¸¦ OCR å®Œæˆå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ¨å®šå›è¦†æ™‚é–“ï¼›ä¹Ÿæœƒé¡¯ç¤ºæ™‚é–“æŒ‰éˆ•ä¾›ä½ ä¿®æ­£ã€‚</div>
        <div id="timePicker" class="timeBtns"></div>

        <button id="undoPickBtn" class="ghostBtn" type="button">æ’¤éŠ·ä¸Šä¸€æ­¥ï¼ˆé»éŒ¯æ™‚é–“ï¼‰</button>
        <button id="undoRecordBtn" class="ghostBtn" type="button">åˆªé™¤æœ€å¾Œä¸€æ¬¡å›è¦†ç´€éŒ„</button>

        <div class="hint" id="timeStats"></div>
        <canvas id="trendChart" width="620" height="190"></canvas>
      </div>
    </div>

    <button id="analyzeBtn" type="button">é–‹å§‹åˆ†æï¼ˆä¸ç”¨æ¨™è¨»ä¹Ÿèƒ½ç”¨ï¼‰</button>

    <div class="status" id="statusBox" style="display:none"></div>
    <div class="result" id="result"></div>
    <div class="hint" id="hint"></div>

    <div class="divider"></div>

    <div class="status" id="replyCoach" style="display:none"></div>
    <button id="copyBtn" class="ghostBtn" type="button" style="display:none">ä¸€éµè¤‡è£½å»ºè­°</button>
  </div>

  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // ===== DOM =====
    const elImage = document.getElementById('image');
    const elPreviewWrap = document.getElementById('previewWrap');
    const elPreview = document.getElementById('preview');
    const elChat = document.getElementById('chat');
    const elAnalyzeBtn = document.getElementById('analyzeBtn');
    const elStatusBox = document.getElementById('statusBox');
    const elResult = document.getElementById('result');
    const elHint = document.getElementById('hint');
    const elHistoryBox = document.getElementById('historyBox');

    const elAppMode = document.getElementById('appMode');
    const elTimeGuide = document.getElementById('timeGuide');
    const elTimePicker = document.getElementById('timePicker');
    const elTimeStats = document.getElementById('timeStats');

    const elReplyCoach = document.getElementById('replyCoach');
    const elCopyBtn = document.getElementById('copyBtn');

    // ===== Storage =====
    const STORE_CHAT_KEY  = "chat_history_v3";
    const STORE_REPLY_KEY = "her_reply_times_v3";

    // ===== State =====
    let pendingTimes = [];            // æœ€æ–°æˆªåœ–æŠ“åˆ°çš„æ™‚é–“ï¼ˆå»å™ªå¾Œï¼‰
    let picked = [];                  // æ‰‹å‹•é»é¸ï¼šä½ ç™¼/å¥¹å›
    let latestHerReplyMinutes = null; // æ‰‹å‹•ä¿®æ­£å€¼ï¼ˆæœ‰å°±è¦†è“‹è‡ªå‹•ï¼‰

    // ===== Helpers =====
    function setStatus(msg){
      elStatusBox.style.display = 'block';
      elStatusBox.textContent = msg;
    }
    function clearStatus(){
      elStatusBox.style.display = 'none';
      elStatusBox.textContent = "";
    }
    function loadJSON(key, fallback){
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }
    function loadChatHistory(){ return loadJSON(STORE_CHAT_KEY, []); }
    function saveChatHistory(items){ saveJSON(STORE_CHAT_KEY, items); }
    function appendChatHistory(item){
      const items = loadChatHistory();
      items.push(item);
      saveChatHistory(items);
      return items;
    }
    function loadReplyHistory(){ return loadJSON(STORE_REPLY_KEY, []); }
    function saveReplyHistory(items){ saveJSON(STORE_REPLY_KEY, items); }
    function appendReplyHistory(item){
      const items = loadReplyHistory();
      items.push(item);
      saveReplyHistory(items);
      return items;
    }

    function renderHistory(){
      const items = loadChatHistory();
      const replies = loadReplyHistory();

      if(!items.length){
        elHistoryBox.innerHTML = "ç›®å‰æ²’æœ‰å°è©±ç´€éŒ„ã€‚ä¸Šå‚³æˆªåœ–å¾Œï¼Œæˆ‘æœƒæŠŠæ¯æ¬¡ OCR çš„æ–‡å­—å­˜åœ¨æœ¬æ©Ÿã€‚";
      } else {
        const last = items[items.length-1];
        elHistoryBox.innerHTML =
          `å·²ç´¯ç©å°è©±ï¼š<b>${items.length}</b> æ¬¡<br>` +
          `æœ€è¿‘ä¸€æ¬¡ï¼š${new Date(last.ts).toLocaleString()}<br>` +
          `æœ€è¿‘æ‘˜è¦ï¼š<br><span style="opacity:.92;white-space:pre-wrap">${(last.text||"").slice(0,180)}</span>`;
      }

      if(replies.length){
        elTimeStats.textContent = buildReplyStatsText(replies);
      } else {
        if(!elTimeStats.textContent) elTimeStats.textContent = "";
      }
    }

    // iPhone çœè¨˜æ†¶é«”ï¼šç¸®åœ–
    async function downscaleToDataURL(file, maxSide=1400, quality=0.88){
      const img = new Image();
      const dataUrl = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
      await new Promise((res, rej) => {
        img.onload = res; img.onerror = rej; img.src = dataUrl;
      });

      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      return canvas.toDataURL('image/jpeg', quality);
    }

    // OCRï¼šç¹ä¸­
    async function runOCR(imageDataUrl){
      const worker = await Tesseract.createWorker('chi_tra', 1, {
        logger: m => {
          if (m.status && typeof m.progress === 'number') {
            const p = Math.round(m.progress * 100);
            setStatus(`ğŸ” OCR è®€åœ–ä¸­â€¦ ${m.status}ï¼ˆ${p}%ï¼‰`);
          }
        }
      });
      try{
        await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK });
        const { data } = await worker.recognize(imageDataUrl);
        return (data.text || "")
          .replace(/[ \t]+\n/g, "\n")
          .replace(/\n{3,}/g, "\n\n")
          .trim();
      } finally {
        await worker.terminate();
      }
    }

    // ===== Time parsing / filtering =====
    function extractTimesHHMM(text){
      // æ”¯æ´ 9:05 / 09:05 / 9ï¼š05ï¼ˆå…¨å½¢å†’è™Ÿï¼‰
      const re = /\b([01]?\d|2[0-3])[ï¼š:]\s*([0-5]\d)\b/g;
      const out = [];
      const seen = new Set();
      let m;
      while((m = re.exec(text)) !== null){
        const t = `${m[1]}:${m[2]}`; // çµ±ä¸€æˆåŠå½¢
        if(!seen.has(t)){ seen.add(t); out.push(t); }
      }
      return out;
    }

    function toMinutes(hhmm){
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    }
    function diffMinutes(a, b){
      let d = b-a;
      if(d < 0) d += 1440;
      return d;
    }

    function filterTimesByMode(times, mode){
      let out = times.slice();

      // å»æ‰ã€Œå¤ªå¯†é›†ã€å™ªéŸ³ï¼šç›¸é„°å·®å¤ªå°
      const minGap = (mode === "ig") ? 2 : 1; // IG ç¨åš´æ ¼
      const keep = [];
      for(const t of out){
        if(!keep.length){ keep.push(t); continue; }
        const d = diffMinutes(toMinutes(keep[keep.length-1]), toMinutes(t));
        if(d >= minGap) keep.push(t);
      }
      out = keep;

      // IG å†å¤šä¸€é“ï¼šå»æ‰è·¨åº¦è¶…é•·ï¼ˆé€šå¸¸ä¸æ˜¯åŒæ®µå°è©±ï¼‰
      if(mode === "ig"){
        const igKeep = [];
        for(const t of out){
          if(!igKeep.length){ igKeep.push(t); continue; }
          const d = diffMinutes(toMinutes(igKeep[igKeep.length-1]), toMinutes(t));
          if(d <= 600) igKeep.push(t); // 10 å°æ™‚å…§
        }
        if(igKeep.length >= 2) out = igKeep;
      }

      // autoï¼šæŒ‰æ•¸é‡èª¿æ•´
      if(mode === "auto" && out.length >= 10){
        const autoKeep = [];
        for(const t of out){
          if(!autoKeep.length){ autoKeep.push(t); continue; }
          const d = diffMinutes(toMinutes(autoKeep[autoKeep.length-1]), toMinutes(t));
          if(d >= 2 && d <= 600) autoKeep.push(t);
        }
        if(autoKeep.length >= 2) out = autoKeep;
      }
      return out;
    }

    // è‡ªå‹•æ¨å®šã€Œå¥¹å›ä½ å¤šä¹…ã€ï¼ˆä¿å®ˆï¼Œä¸è£ç¥ï¼‰
    function autoEstimateReplyMinutes(times){
      if(!times || times.length < 2) return null;

      const mins = times.map(toMinutes);
      const diffs = [];
      for(let i=0;i<mins.length-1;i++){
        let d = diffMinutes(mins[i], mins[i+1]);
        // æ’é™¤å¤ªè¿‘/å¤ªé ï¼šå¤ªè¿‘å¤šç‚ºé€£ç™¼æˆ–å™ªéŸ³ï¼›å¤ªé å¯èƒ½éš”å¤©/ä¸åŒæ®µ
        if(d >= 2 && d <= 480) diffs.push(d);
      }
      if(!diffs.length) return null;

      diffs.sort((a,b)=>a-b);
      const mid = diffs.length % 2
        ? diffs[(diffs.length-1)/2]
        : (diffs[diffs.length/2-1] + diffs[diffs.length/2]) / 2;
      return Math.round(mid);
    }

    // ===== Time picker (optional manual override) =====
    function resetPick(){
      picked = [];
      latestHerReplyMinutes = null; // æ‰‹å‹•å€¼æ¸…æ‰ï¼ˆè®“å®ƒå›åˆ°è‡ªå‹•ï¼‰
      elTimePicker.querySelectorAll(".timeBtn").forEach(b => b.classList.remove("picked"));
      elTimeGuide.textContent = "ï¼ˆé¸å¡«ï¼‰ä½ è¦ºå¾—ä¸æº–å†é»ï¼šâ‘ ä½ ç™¼çš„æ™‚é–“ â†’ â‘¡å¥¹å›ä½ çš„æ™‚é–“ï¼ˆæœƒè¦†è“‹è‡ªå‹•æ¨å®šï¼‰";
    }

    function renderTimePicker(times){
      elTimePicker.innerHTML = "";
      if(times.length < 2){
        elTimeGuide.textContent = "âš ï¸ é€™å¼µæˆªåœ–æŠ“ä¸åˆ°è¶³å¤ æ™‚é–“ï¼ˆå°‘æ–¼ 2 å€‹ï¼‰ã€‚ç³»çµ±æœƒç”¨æ–‡å­—å…§å®¹åˆ¤æ–·ï¼›è‹¥è¦å›è¦†æ™‚é–“ï¼Œè«‹æˆªåˆ°æœ‰é¡¯ç¤ºæ™‚é–“ã€‚";
        pendingTimes = [];
        return;
      }
      elTimeGuide.textContent = "ç³»çµ±å·²è‡ªå‹•æ¨å®šå›è¦†æ™‚é–“ï¼›è‹¥è¦ºå¾—ä¸æº–ï¼Œå¯é»ï¼šâ‘ ä½ ç™¼ â†’ â‘¡å¥¹å›ï¼ˆè¦†è“‹è‡ªå‹•ï¼‰";
      for(const t of times){
        const b = document.createElement("button");
        b.type="button";
        b.className="timeBtn";
        b.textContent=t;
        b.dataset.t=t;
        b.addEventListener("click", () => onPickTime(b));
        elTimePicker.appendChild(b);
      }
      // ä¸å¼·åˆ¶ï¼Œæ‰€ä»¥ä¸é–ä»»ä½•æ±è¥¿ï¼›åªé‡ç½®æç¤º
      picked = [];
    }

    function onPickTime(btn){
      const t = btn.dataset.t;
      if(picked.length >= 2) return;

      picked.push(t);
      btn.classList.add("picked");

      if(picked.length === 1){
        elTimeGuide.textContent = `å·²é¸ â‘  ä½ ç™¼ï¼š${picked[0]}ï¼Œå†é» â‘¡ å¥¹å›ä½ çš„æ™‚é–“`;
        return;
      }

      if(picked.length === 2){
        const myT = picked[0], herT = picked[1];
        const d = diffMinutes(toMinutes(myT), toMinutes(herT));
        latestHerReplyMinutes = d;

        const arr = appendReplyHistory({ ts: Date.now(), myTime: myT, herTime: herT, diff: d });
        elTimeStats.textContent = buildReplyStatsText(arr);
        renderTrendChart();

        elTimeGuide.textContent = `âœ… å·²æ‰‹å‹•ä¿®æ­£ï¼šå¥¹é€™æ¬¡å›ä½  ${d} åˆ†é˜ï¼ˆå·²è¨˜éŒ„ï¼‰`;
      }
    }

    // æ’¤éŠ·é»é¸ï¼ˆåªæ’¤éŠ·æœ¬æ¬¡ï¼‰
    document.getElementById("undoPickBtn").addEventListener("click", () => {
      if(!picked.length) return;
      const last = picked.pop();

      // å–æ¶ˆä¸€å€‹ picked æ¨£å¼ï¼ˆæ‰¾æœ€æœ«ä¸€å€‹ç¬¦åˆä¸” picked çš„ï¼‰
      const btns = [...elTimePicker.querySelectorAll(".timeBtn")].filter(b => b.dataset.t === last && b.classList.contains("picked"));
      if(btns.length) btns[btns.length-1].classList.remove("picked");

      // åªè¦ä¸æ˜¯å®Œæ•´å…©é»ï¼Œå°±è¦–ç‚ºå°šæœªæ‰‹å‹•è¦†è“‹ï¼ˆå›åˆ°è‡ªå‹•ï¼‰
      latestHerReplyMinutes = null;

      if(picked.length === 0) elTimeGuide.textContent = "ï¼ˆé¸å¡«ï¼‰ä½ è¦ºå¾—ä¸æº–å†é»ï¼šâ‘ ä½ ç™¼çš„æ™‚é–“ â†’ â‘¡å¥¹å›ä½ çš„æ™‚é–“ï¼ˆæœƒè¦†è“‹è‡ªå‹•æ¨å®šï¼‰";
      if(picked.length === 1) elTimeGuide.textContent = `å·²é¸ â‘  ä½ ç™¼ï¼š${picked[0]}ï¼Œå†é» â‘¡ å¥¹å›ä½ çš„æ™‚é–“`;
    });

    // åˆªé™¤æœ€å¾Œä¸€æ¬¡å›è¦†ç´€éŒ„ï¼ˆæœƒå½±éŸ¿çµ±è¨ˆ/åœ–ï¼‰
    document.getElementById("undoRecordBtn").addEventListener("click", () => {
      const arr = loadReplyHistory();
      if(!arr.length) return;
      arr.pop();
      saveReplyHistory(arr);

      elTimeStats.textContent = arr.length ? buildReplyStatsText(arr) : "";
      renderTrendChart();

      elTimeGuide.textContent = "å·²åˆªé™¤æœ€å¾Œä¸€æ¬¡å›è¦†ç´€éŒ„ã€‚";
    });

    function buildReplyStatsText(arr){
      const diffs = arr.map(x=>x.diff).slice().sort((a,b)=>a-b);
      const sum = diffs.reduce((s,x)=>s+x,0);
      const avg = sum / diffs.length;
      const median = diffs.length % 2
        ? diffs[(diffs.length-1)/2]
        : (diffs[diffs.length/2-1] + diffs[diffs.length/2]) / 2;
      const min = diffs[0], max = diffs[diffs.length-1];

      let trend = "";
      if(arr.length >= 3){
        const last3 = arr.slice(-3).map(x=>x.diff);
        const first = last3[0], last = last3[2];
        if(last - first >= 10) trend = "ï¼ˆæœ€è¿‘è®Šæ…¢ï¼‰";
        else if(first - last >= 10) trend = "ï¼ˆæœ€è¿‘è®Šå¿«ï¼‰";
        else trend = "ï¼ˆæœ€è¿‘å·®ä¸å¤šï¼‰";
      }

      return `â±ï¸ å¥¹å›è¦†çµ±è¨ˆï¼ˆç´¯ç© ${arr.length} æ¬¡ï¼‰
æœ€æ–°ï¼š${arr[arr.length-1].diff} åˆ†
å¹³å‡ï¼š${avg.toFixed(1)} åˆ†ï½œä¸­ä½æ•¸ï¼š${median} åˆ†ï½œæœ€çŸ­ï¼š${min} åˆ†ï½œæœ€é•·ï¼š${max} åˆ† ${trend}`;
    }

    // è¶¨å‹¢åœ–ï¼ˆæœ€è¿‘ 7 æ¬¡ï¼‰
    function renderTrendChart(){
      const canvas = document.getElementById("trendChart");
      const ctx = canvas.getContext("2d");
      const arr = loadReplyHistory();
      const lastN = arr.slice(-7);
      const data = lastN.map(x=>x.diff);

      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(!data.length){
        ctx.fillStyle = "rgba(229,231,235,.75)";
        ctx.font = "14px system-ui";
        ctx.fillText("è¶¨å‹¢åœ–ï¼šå°šç„¡è³‡æ–™ï¼ˆå…ˆä¸Šå‚³æˆªåœ–æˆ–æ‰‹å‹•ä¿®æ­£ä¸€æ¬¡ï¼‰", 14, 28);
        return;
      }

      const padL=42, padR=12, padT=18, padB=28;
      const W=canvas.width, H=canvas.height;
      const innerW=W-padL-padR, innerH=H-padT-padB;

      const maxV=Math.max(...data), minV=Math.min(...data);
      const span=Math.max(1, maxV-minV);

      // axes
      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.beginPath();
      ctx.moveTo(padL,padT);
      ctx.lineTo(padL,H-padB);
      ctx.lineTo(W-padR,H-padB);
      ctx.stroke();

      // labels
      ctx.fillStyle="rgba(229,231,235,.75)";
      ctx.font="12px system-ui";
      ctx.fillText(String(maxV), 8, padT+10);
      ctx.fillText(String(minV), 8, H-padB);

      // points
      const pts=data.map((v,i)=>{
        const x=padL+(data.length===1?innerW/2:(innerW*i/(data.length-1)));
        const y=padT+(innerH*(1-(v-minV)/span));
        return {x,y,v};
      });

      // line
      ctx.strokeStyle="rgba(56,189,248,.95)";
      ctx.lineWidth=2;
      ctx.beginPath();
      pts.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
      ctx.stroke();

      // dots
      ctx.fillStyle="rgba(52,211,153,.95)";
      pts.forEach(p=>{
        ctx.beginPath(); ctx.arc(p.x,p.y,3.5,0,Math.PI*2); ctx.fill();
      });

      // title
      ctx.fillStyle="rgba(229,231,235,.85)";
      ctx.font="13px system-ui";
      ctx.fillText("æœ€è¿‘ 7 æ¬¡ï¼šå¥¹å›ä½ å¤šä¹…ï¼ˆåˆ†é˜ï¼‰", padL, 14);
    }

    // ===== Reply Coach =====
    function buildReplyCoach(label, replyMin){
      const slow = (typeof replyMin === "number" && replyMin >= 120);
      const verySlow = (typeof replyMin === "number" && replyMin >= 360);
      const opener = "æ¬¸æˆ‘å‰›æƒ³åˆ°ä½ ä¸Šæ¬¡èªªçš„é‚£å€‹ğŸ˜‚";

      let title = "ğŸ“Œ ä½ å¯ä»¥é€™æ¨£å›ï¼ˆé¸ä¸€å€‹ç›´æ¥è²¼ï¼‰";
      let lines = [];
      let stoploss = "æ­¢æç·šï¼šä½ ä¸Ÿçƒ 2 æ¬¡éƒ½æ²’æ¥ï¼ˆåªå›å—¯/å¥½/å–”æˆ–ä¸å»¶ä¼¸ï¼‰ï¼Œå°±åœ 3 å¤©ã€‚";

      if (label.includes("å¾ˆç†±") || label.includes("ğŸ”¥")) {
        lines = [
          `${opener} ä½ ä»Šå¤©ä»€éº¼æ™‚å€™æ¯”è¼ƒæœ‰ç©ºï¼Ÿæˆ‘æƒ³ç´„ä½ å–å€‹é£²æ–™ï½`,
          `æˆ‘ç™¼ç¾è·Ÿä½ èŠå¤©è »èˆ’æœçš„ğŸ˜‚ é€™é€±æ‰¾ä¸€å¤©å‡ºä¾†èµ°èµ°ï¼Ÿ`,
          `é‚£æˆ‘å…ˆå»å¿™ä¸€ä¸‹ï½æ™šé»å†æ‰¾ä½ ï¼ˆé †ä¾¿æƒ³ç´„ä½ ï¼‰`
        ];
        stoploss = "åŠ é€Ÿæ³•ï¼šç›´æ¥ä¸Ÿæ—¥æœŸé¸é …ï¼šé€±äº”æˆ–é€±æ—¥å“ªå¤©æ¯”è¼ƒå¯ä»¥ï¼Ÿ";
      } else if (label.includes("æ›–æ˜§") || label.includes("ğŸŒ¤ï¸")) {
        lines = [
          `${opener} é€™é€±ä½ å“ªå¤©æ¯”è¼ƒæœ‰ç©ºï¼Ÿæˆ‘æƒ³è«‹ä½ å–å€‹é£²æ–™/åƒå°æ±è¥¿ï½`,
          `ä½ å‰›å‰›é‚£å¥å¾ˆå¥½ç¬‘ğŸ˜‚ ä¹‹å¾Œæƒ³è½ä½ å¤šè¬›ä¸€é»ï½ï¼ˆé †ä¾¿ç´„ä½ ï¼‰`,
          `æˆ‘å…ˆå»å¿™ï½ä½ æ–¹ä¾¿å†å›å°±å¥½ğŸ™‚`
        ];
        if (slow) lines.unshift(`ä½ å¿™æ²’é—œä¿‚ï½ä½ æ–¹ä¾¿å†å›æˆ‘å°±å¥½ğŸ™‚ï¼ˆæˆ‘ä¸æ€¥ï¼‰`);
      } else if (label.includes("åå†·") || label.includes("ğŸ§Š")) {
        lines = [
          `å¥½ï½é‚£ä½ å…ˆå¿™ğŸ™‚ï¼ˆæˆ‘å…ˆå»å¿™æˆ‘çš„ï¼Œæ™šé»å†èªªï¼‰`,
          `æˆ‘æƒ³ç¢ºèªä¸€ä¸‹ï¼šä½ æ¯”è¼ƒå–œæ­¡æˆ‘æ€éº¼è·Ÿä½ èŠï¼Ÿï¼ˆè¼•é¬†èŠå¤©/æœ‰ç©ºå†èŠéƒ½è¡Œï¼‰`,
          `é€™é€±ä½ å¦‚æœæœ‰ç©ºæˆ‘å€‘å–å€‹é£²æ–™å°±å¥½ï¼Œä¸æ–¹ä¾¿ä¹Ÿæ²’é—œä¿‚ï½`
        ];
        stoploss = "æ­¢æç·šï¼šä¸€æ¬¡é‚€ç´„ï¼‹ä¸€æ¬¡æ”¶å°¾å¾Œï¼Œ3 å¤©å…§æ²’æ¨é€²ï¼ˆä¸çµ¦æ™‚é–“/ä¸å»¶ä¼¸/ä¸ä¸»å‹•ï¼‰ï¼Œå°±å…ˆåœæ­¢ä¸»å‹•ã€‚";
        if (verySlow) title = "ğŸ“Œ ä½ å¯ä»¥é€™æ¨£å›ï¼ˆå…ˆæ”¶æ‰‹ã€ä¿è­·è‡ªå·±ï¼‰";
      } else {
        lines = [
          `${opener} ä½ ç¾åœ¨æ–¹ä¾¿å›å—ï¼Ÿ`,
          `ä½ ä»Šå¤©éå¾—æ€æ¨£ï¼Ÿæˆ‘å‰›å¿™å®Œï½`,
          `æˆ‘å…ˆå»å¿™ï½ä½ æœ‰ç©ºå†å›å°±å¥½ğŸ™‚`
        ];
      }

      // ç¢ºä¿è‡³å°‘ 3 å¥
      while(lines.length < 3) lines.push(lines[lines.length-1] || "æˆ‘å…ˆå»å¿™ï½ä½ æœ‰ç©ºå†å›å°±å¥½ğŸ™‚");

      return { title, lines: lines.slice(0,3), stoploss };
    }

    // ===== Core analysis =====
    function analyzeText(allText, replyMin){
      let score = 0;
      const t = allText || "";

      const HOT  = ["æƒ³ä½ ","æƒ³è¦‹ä½ ","æˆ‘æƒ³ä½ ","æŠ±æŠ±","è¦ªè¦ª","æ„›ä½ ","å–œæ­¡ä½ ","å¯¶","å¯¶è²","â¤ï¸","ğŸ˜˜","ğŸ˜","æ™šå®‰â¤ï¸","æƒ³ä½ äº†"];
      const WARM = ["å“ˆå“ˆ","ç¬‘æ­»","æ¬¸","åœ¨å—","ä½ åœ¨å¹¹å˜›","å¹¹å˜›","å¯ä»¥å•Š","å¥½å‘€","OK","è¡Œ","æ™šå®‰","æ—©å®‰","åƒé£¯","å‡ºå»","ä¸‹æ¬¡","æ”¹å¤©"];
      const COLD = ["å—¯","å–”","å“¦","å¥½","éš¨ä¾¿","ä¸çŸ¥é“","å†èªª","å¿™","å…ˆé€™æ¨£","æ°","å‘µ","å·²è®€","å·²è®€ä¸å›","å›å¾ˆæ…¢","æ•·è¡","ä¸å›","éƒ½æˆ‘ä¸»å‹•"];

      HOT.forEach(w => { if(t.includes(w)) score += 2; });
      WARM.forEach(w => { if(t.includes(w)) score += 1; });
      COLD.forEach(w => { if(t.includes(w)) score -= 1; });

      if (t.replace(/\s/g,"").length <= 2) score -= 1;
      ["å·²è®€ä¸å›","å›å¾ˆæ…¢","éƒ½æˆ‘ä¸»å‹•"].forEach(w => { if(t.includes(w)) score -= 2; });

      // å›è¦†æ™‚é–“åŠ æ¬Šï¼ˆè‡ªå‹•æ¨å®šæˆ–æ‰‹å‹•è¦†è“‹ï¼‰
      if(typeof replyMin === "number"){
        if(replyMin <= 10) score += 3;
        else if(replyMin <= 30) score += 2;
        else if(replyMin <= 60) score += 1;
        else if(replyMin <= 180) score -= 1;
        else score -= 2;
      }

      let label = "ğŸ˜ æ™®é€š";
      let advice = "å»ºè­°ï¼šç”¨ä¸€æ¬¡è¼•é‡é‚€ç´„æ¸¬å¥¹æœƒä¸æœƒæŠŠæ™‚é–“çµ¦ä½ ï¼ˆæ¯”ä¸€ç›´èŠå¤©æ›´æº–ï¼‰ã€‚";

      if(score >= 6){
        label = "ğŸ”¥ å¾ˆç†±";
        advice = "è¶ç†±æŠŠé‚€ç´„è½åœ°ï¼šçµ¦ã€æ™‚é–“ + åœ°é» + ä¸€å€‹é¸é …ã€ï¼Œä¸è¦é€£ç™¼è¿½å•ã€‚";
      } else if(score >= 3){
        label = "ğŸŒ¤ï¸ æ›–æ˜§";
        advice = "ç¶­æŒç¯€å¥ï¼šçŸ­å¥ã€æœ‰æ”¶å°¾ï¼›ç”¨ä¸€æ¬¡é‚€ç´„æ¸¬å¥¹é¡˜ä¸é¡˜æ„æŠŠäº’å‹•æ¨åˆ°ç¾å¯¦ã€‚";
      } else if(score <= 0){
        label = "ğŸ§Š åå†·";
        advice = "å…ˆé™é »ï¼Œä¸é€£ç™¼ï¼›å†ç”¨ä¸€æ¬¡ä¸å£“è¿«é‚€ç´„åšåˆ†æ°´å¶ºï¼Œæ²’æ¥çƒå°±åœ 3 å¤©ã€‚";
      }

      return { score, label, advice };
    }

    // ===== Events =====
    elImage.addEventListener('change', async () => {
      const files = Array.from(elImage.files || []);
      if(!files.length) return;

      clearStatus();
      elResult.textContent = "";
      elHint.textContent = "";
      elReplyCoach.style.display = "none";
      elCopyBtn.style.display = "none";

      // æ–°ä¸€æ‰¹ä¸Šå‚³ï¼šå…ˆæ¸…æ‰ã€Œæ‰‹å‹•è¦†è“‹ã€
      picked = [];
      latestHerReplyMinutes = null;

      // é è¨­ï¼šå…ˆä¸æ¸…ç©º pendingTimesï¼Œç­‰æœ€å¾Œä¸€å¼µ OCR å¾Œæ›´æ–°
      pendingTimes = [];
      elTimePicker.innerHTML = "";
      elTimeStats.textContent = loadReplyHistory().length ? buildReplyStatsText(loadReplyHistory()) : "";

      for(let i=0;i<files.length;i++){
        setStatus(`ğŸ–¼ï¸ ç¬¬ ${i+1}/${files.length} å¼µï¼šç¸®åœ–ä¸­â€¦`);
        const dataUrl = await downscaleToDataURL(files[i], 1400, 0.88);

        // é è¦½é¡¯ç¤ºæœ€å¾Œä¸€å¼µï¼ˆé¿å…ä¸€ç›´é–ƒï¼‰
        if(i === files.length - 1){
          elPreview.src = dataUrl;
          elPreviewWrap.style.display = "block";
        }

        try{
          setStatus(`ğŸ” ç¬¬ ${i+1}/${files.length} å¼µï¼šOCR è®€åœ–ä¸­â€¦`);
          const text = await runOCR(dataUrl);
          const clean = (text || "").trim();
          if(!clean){
            setStatus(`âš ï¸ ç¬¬ ${i+1} å¼µï¼šæ²’è¾¨è­˜åˆ°æ–‡å­—ï¼ˆç•¥éï¼‰ã€‚`);
            continue;
          }

          appendChatHistory({ ts: Date.now(), text: clean });
          elChat.value = clean; // æŠŠæœ€æ–°ä¸€å¼µå¡é€²æ–‡å­—æ¡†ï¼Œæ–¹ä¾¿ä½ æ”¹
          renderHistory();

          // åªç”¨ã€Œæœ€å¾Œä¸€å¼µã€çš„æ™‚é–“ä¾†åšè‡ªå‹•æ¨å®š/æ‰‹å‹•ä¿®æ­£ï¼ˆæœ€ç¬¦åˆç•¶æ¬¡æƒ…å¢ƒï¼‰
          if(i === files.length - 1){
            const raw = extractTimesHHMM(clean);
            const mode = elAppMode.value;
            pendingTimes = filterTimesByMode(raw, mode);
            renderTimePicker(pendingTimes);

            // è‡ªå‹•æ¨å®šï¼ˆä¸è¨˜éŒ„åˆ°æ­·å²ï¼Œåªæ˜¯ç•¶æ¬¡é ä¼°ï¼‰
            const autoMin = autoEstimateReplyMinutes(pendingTimes);
            if(typeof autoMin === "number"){
              elTimeGuide.textContent = `âœ… ç³»çµ±è‡ªå‹•æ¨å®šï¼šå¥¹å¤§ç´„ ${autoMin} åˆ†é˜å›ä½ ï¼ˆä½ è¦ºå¾—ä¸æº–å†æ‰‹å‹•é»å…©å€‹æ™‚é–“ä¿®æ­£ï¼‰`;
            } else {
              elTimeGuide.textContent = "âš ï¸ ç³»çµ±ç„¡æ³•è‡ªå‹•æ¨å®šå›è¦†æ™‚é–“ï¼ˆæ™‚é–“å¤ªå°‘æˆ–å¤ªäº‚ï¼‰ã€‚ä½ å¯ä»¥æ‰‹å‹•é»ï¼šä½ ç™¼â†’å¥¹å›ã€‚";
            }
          }

          setStatus(`âœ… ç¬¬ ${i+1}/${files.length} å¼µï¼šå®Œæˆï¼ˆå·²å­˜æœ¬æ©Ÿï¼‰ã€‚`);
        } catch(e){
          console.error(e);
          setStatus(`âŒ ç¬¬ ${i+1}/${files.length} å¼µï¼šOCR å¤±æ•—ï¼ˆç•¥éï¼‰ã€‚`);
        }
      }

      renderTrendChart();
      setStatus("âœ… å…¨éƒ¨è™•ç†å®Œæˆï¼šä½ å¯ä»¥ç›´æ¥æŒ‰ã€Œé–‹å§‹åˆ†æã€ã€‚");
    });

    // æ¨¡å¼åˆ‡æ›ï¼šå¦‚æœå·²ç¶“æœ‰ pendingTimesï¼Œå°±é‡æ–°éæ¿¾+é‡ç•«æŒ‰éˆ•
    elAppMode.addEventListener("change", () => {
      if(!pendingTimes || !pendingTimes.length){
        // è‹¥ pendingTimes ç›®å‰æ˜¯ç©ºï¼Œä½†ä¹Ÿå¯èƒ½ raw å·²ç¶“ä¸Ÿæ‰ï¼›é€™è£¡å°±ä¸ç¡¬é‡ç®—
        return;
      }
      // é€™è£¡ä¸é‡æŠ“ rawï¼ˆçœäº‹ï¼‰ï¼›ç”¨ç¾æœ‰ pendingTimes å†éæ¿¾æ„ç¾©ä¸å¤§ï¼Œæ‰€ä»¥ä¿ç•™
      // è‹¥ä½ æƒ³æ›´åš´è¬¹ï¼šä¸‹ä¸€æ¬¡ä¸Šå‚³æ™‚å°±æœƒå¥—ç”¨æ–°æ¨¡å¼
    });

    elAnalyzeBtn.addEventListener('click', () => {
      const typed = (elChat.value || "").trim();
      const history = loadChatHistory();
      const allText = history.map(x => x.text).join("\n\n---\n\n");
      const textForAnalysis = (allText + (typed ? ("\n\n[æœ€æ–°è£œå……]\n" + typed) : "")).trim();

      if(!textForAnalysis){
        elResult.textContent = "âš ï¸ æ²’æœ‰å¯åˆ†æçš„æ–‡å­—";
        elHint.textContent = "å…ˆä¸Šå‚³æˆªåœ–æˆ–è²¼å¹¾å¥æ–‡å­—ã€‚";
        return;
      }

      // å›è¦†æ™‚é–“ï¼šæ‰‹å‹•è¦†è“‹å„ªå…ˆï¼›å¦å‰‡ç”¨è‡ªå‹•æ¨å®š
      let replyMin = latestHerReplyMinutes;
      let autoUsed = false;
      if(replyMin == null){
        const autoMin = autoEstimateReplyMinutes(pendingTimes);
        if(typeof autoMin === "number"){
          replyMin = autoMin;
          autoUsed = true;
        }
      }

      clearStatus();
      const { score, label, advice } = analyzeText(textForAnalysis, replyMin);

      const hCount = history.length;
      const replyText = (typeof replyMin === "number")
        ? (autoUsed ? `å¥¹ç´„ ${replyMin} åˆ†å›ï¼ˆè‡ªå‹•æ¨å®šï¼‰` : `å¥¹å›ä½  ${replyMin} åˆ†ï¼ˆæ‰‹å‹•ä¿®æ­£ï¼‰`)
        : "å›è¦†æ™‚é–“ï¼šæœªçŸ¥";

      elResult.textContent = `${label}ï¼ˆç´¯ç© ${hCount} æ¬¡ï½œ${replyText}ï¼‰`;
      elHint.textContent = advice + (autoUsed ? "\n\nï¼ˆæç¤ºï¼šä½ è¦ºå¾—å›è¦†æ™‚é–“ä¸æº–ï¼Œå¯åœ¨ä¸‹æ–¹æ‰‹å‹•é»ã€ä½ ç™¼â†’å¥¹å›ã€è¦†è“‹ã€‚ï¼‰" : "");

      // å›è¦†æ•™ç·´
      const coach = buildReplyCoach(label, replyMin);
      elReplyCoach.style.display = "block";
      elReplyCoach.innerHTML =
        `<b>${coach.title}</b><br><br>` +
        `1) ${coach.lines[0]}<br>` +
        `2) ${coach.lines[1]}<br>` +
        `3) ${coach.lines[2]}<br><br>` +
        `<span style="opacity:.9">ğŸ›‘ ${coach.stoploss}</span>`;

      elCopyBtn.style.display = "block";
      elCopyBtn.textContent = "ä¸€éµè¤‡è£½å»ºè­°";
      elCopyBtn.onclick = async () => {
        const text = coach.lines[0];
        try{
          await navigator.clipboard.writeText(text);
          elCopyBtn.textContent = "âœ… å·²è¤‡è£½ï¼ˆå»è²¼çµ¦å¥¹ï¼‰";
          setTimeout(()=> elCopyBtn.textContent = "ä¸€éµè¤‡è£½å»ºè­°", 1200);
        } catch(e){
          alert("è¤‡è£½å¤±æ•—ï¼šè«‹é•·æŒ‰æ‰‹å‹•è¤‡è£½ç¬¬ä¸€å¥ã€‚");
        }
      };
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem(STORE_CHAT_KEY);
      localStorage.removeItem(STORE_REPLY_KEY);

      // reset UI
      elChat.value = "";
      elPreviewWrap.style.display = "none";
      elPreview.src = "";
      elTimePicker.innerHTML = "";
      elTimeGuide.textContent = "å·²æ¸…é™¤ã€‚è«‹é‡æ–°ä¸Šå‚³æˆªåœ–ã€‚";
      elTimeStats.textContent = "";
      pendingTimes = [];
      picked = [];
      latestHerReplyMinutes = null;

      elResult.textContent = "";
      elHint.textContent = "";
      elReplyCoach.style.display = "none";
      elCopyBtn.style.display = "none";

      clearStatus();
      renderHistory();
      renderTrendChart();
      setStatus("ğŸ§¹ å·²æ¸…é™¤æœ¬æ©Ÿå°è©±èˆ‡å›è¦†ç´€éŒ„ã€‚");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const payload = {
        chatHistory: loadChatHistory(),
        replyHistory: loadReplyHistory()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat_history_export.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // init
    renderHistory();
    renderTrendChart();
  </script>
</body>
</html>
