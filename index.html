<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŠå¤©æº«åº¦è¨ˆï¼ˆå…è²»å®Œæ•´ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0f172a; --card:#020617; --text:#e5e7eb; --muted:rgba(229,231,235,.78);
      --line:rgba(255,255,255,.10); --box:#0b1220; --btn:#38bdf8; --btnText:#062235;
      --ok:#34d399; --danger:#fb7185;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif;
      display:flex; justify-content:center; padding:22px 14px;
    }
    .card{
      width:100%; max-width:720px; background:var(--card); border-radius:16px; padding:18px;
      border:1px solid var(--line); box-shadow:0 20px 40px rgba(0,0,0,.45);
    }
    h1{margin:0 0 6px; text-align:center; font-size:20px;}
    .sub{margin:0 0 12px; text-align:center; color:var(--muted); font-size:13px; line-height:1.45;}
    .row{margin-top:10px;}
    input[type="file"], textarea, select{
      width:100%; border-radius:12px; border:1px solid var(--line);
      background:var(--box); color:var(--text);
    }
    input[type="file"]{padding:10px;}
    textarea{height:150px; padding:10px; resize:none; outline:none; font-size:14px; line-height:1.4;}
    select{padding:10px;}
    .tiny{font-size:12px; color:var(--muted); line-height:1.45; margin-top:6px;}
    .preview{
      margin-top:10px; padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--box);
      display:none;
    }
    .preview img{width:100%; border-radius:10px; display:block;}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:14px 0;}
    button{
      width:100%; margin-top:10px; padding:12px 14px; border:none; border-radius:999px;
      background:var(--btn); color:var(--btnText); font-weight:900; font-size:16px; cursor:pointer;
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    .ghostBtn{
      background:transparent; color:var(--text); border:1px solid var(--line);
      font-weight:800; font-size:14px;
    }
    .dangerBtn{ background:var(--danger); color:#1b0b10; }
    .status{
      margin-top:10px; padding:10px; border-radius:12px;
      background:rgba(56,189,248,.10); border:1px solid rgba(56,189,248,.25);
      font-size:13px; line-height:1.5;
      white-space:pre-wrap;
    }
    .result{
      margin-top:12px; text-align:center; font-size:18px; font-weight:900; min-height:28px;
    }
    .hint{
      margin-top:10px; color:var(--muted); font-size:12px; line-height:1.55; white-space:pre-wrap;
    }
    .timeWrap{
      margin-top:10px; padding:12px; border-radius:12px; background:var(--box); border:1px solid var(--line);
    }
    .timeBtns{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .timeBtn{
      padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03); color:var(--text); font-weight:800; font-size:14px; cursor:pointer;
    }
    .timeBtn.picked{background:var(--ok); color:#022c22; border-color:rgba(52,211,153,.65);}
    canvas{
      width:100%; height:auto; margin-top:10px; border-radius:12px; border:1px solid var(--line); background:var(--box);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>èŠå¤©æº«åº¦è¨ˆï¼ˆå…è²»å®Œæ•´ç‰ˆï¼‰</h1>
    <div class="sub">
      âœ… å¤šå¼µæˆªåœ– OCR è®€å­—ï½œâœ… ç„¡é™ç´¯ç©ï¼ˆæœ¬æ©Ÿï¼‰ï½œâœ… è‡ªå‹•æ¨å®šå¥¹å›ä½ å¤šä¹…ï¼ˆä¸å¼·åˆ¶ï¼‰<br>
      âœ… ä¿¡å¿ƒæŒ‡æ•¸ï¼ˆä¸€å¥è©±ï¼‰ï½œâœ… ç›´æ¥çµ¦ä½ ã€Œæœ€å»ºè­°å›è¦†ä¸€å¥ã€ï¼‹ä¸€éµè¤‡è£½
    </div>

    <div class="row">
      <input id="image" type="file" accept="image/*" multiple />
      <div class="tiny">å»ºè­°ï¼šè£åˆ‡åªç•™å°è©±å€ï¼ˆä¸è¦ç‹€æ…‹åˆ—/éµç›¤ï¼‰ï¼ŒOCR æœƒæ›´æº–ã€‚</div>
    </div>

    <div class="preview" id="previewWrap">
      <img id="preview" alt="é è¦½åœ–ç‰‡" />
    </div>

    <div class="row">
      <div class="tiny">ï¼ˆå¯é¸ï¼‰ä½ ä¹Ÿå¯ä»¥åœ¨é€™è£¡è£œå……/ä¿®æ­£æ–‡å­—ï¼ˆæœƒåŠ åˆ°ç´¯ç©å°è©±æœ€å¾Œé¢ï¼‰ï¼š</div>
      <textarea id="chat" placeholder="ä¾‹å¦‚ï¼šå¥¹å›å¾ˆæ…¢é‚„è¦èŠå—ï¼Ÿæˆ–è²¼ä¸Šå°è©±æ–‡å­—â€¦"></textarea>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="tiny">ğŸ“š æœ¬æ©Ÿç´¯ç©ç´€éŒ„</div>
      <div class="status" id="historyBox"></div>
      <button id="clearBtn" class="dangerBtn" type="button">æ¸…é™¤æœ¬æ©Ÿå°è©±èˆ‡å›è¦†ç´€éŒ„</button>
      <button id="exportBtn" class="ghostBtn" type="button">ä¸‹è¼‰ç´€éŒ„ï¼ˆJSONï¼‰</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="tiny">â±ï¸ å›è¦†æ™‚é–“ï¼ˆè‡ªå‹•æ¨å®šï¼›è¦ºå¾—ä¸æº–å¯é¸å¡«æ‰‹å‹•ä¿®æ­£ï¼šä½ ç™¼â†’å¥¹å›ï¼‰</div>
      <div class="timeWrap">
        <div class="tiny" style="margin-bottom:6px;">
          ä¾†æºï¼š
          <select id="appMode" style="width:auto;display:inline-block;">
            <option value="auto">è‡ªå‹•ï¼ˆå»ºè­°ï¼‰</option>
            <option value="line">LINE</option>
            <option value="ig">IG</option>
          </select>
        </div>

        <div id="timeGuide" class="tiny">ä¸Šå‚³æˆªåœ–ä¸¦ OCR å®Œæˆå¾Œï¼Œé€™è£¡æœƒå‡ºç¾æ™‚é–“æŒ‰éˆ•ï¼ˆå¯é¸å¡«æ‰‹å‹•ä¿®æ­£ï¼‰ã€‚</div>
        <div id="timePicker" class="timeBtns"></div>

        <button id="undoPickBtn" class="ghostBtn" type="button">æ’¤éŠ·ä¸Šä¸€æ­¥ï¼ˆé»éŒ¯æ™‚é–“ï¼‰</button>
        <button id="undoRecordBtn" class="ghostBtn" type="button">åˆªé™¤æœ€å¾Œä¸€æ¬¡å›è¦†ç´€éŒ„</button>

        <div class="hint" id="timeStats"></div>
        <canvas id="trendChart" width="660" height="190"></canvas>
      </div>
    </div>

    <button id="analyzeBtn" type="button">é–‹å§‹åˆ†æ</button>

    <div class="status" id="statusBox" style="display:none"></div>
    <div class="result" id="result"></div>
    <div class="hint" id="hint"></div>

    <div class="status" id="confidenceBox" style="display:none"></div>
    <div class="hint" id="confidenceHelp" style="display:none"></div>
    <button id="improveBtn" class="ghostBtn" type="button" style="display:none">ç«‹å³æå‡ä¿¡å¿ƒ</button>

    <div class="divider"></div>

    <div class="status" id="replyCoach" style="display:none"></div>
    <button id="copyBtn" class="ghostBtn" type="button" style="display:none">è¤‡è£½é€™ä¸€å¥å»å›</button>
  </div>

  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // ===== DOM =====
    const elImage = document.getElementById('image');
    const elPreviewWrap = document.getElementById('previewWrap');
    const elPreview = document.getElementById('preview');
    const elChat = document.getElementById('chat');

    const elAnalyzeBtn = document.getElementById('analyzeBtn');
    const elStatusBox = document.getElementById('statusBox');
    const elResult = document.getElementById('result');
    const elHint = document.getElementById('hint');

    const elHistoryBox = document.getElementById('historyBox');
    const elAppMode = document.getElementById('appMode');
    const elTimeGuide = document.getElementById('timeGuide');
    const elTimePicker = document.getElementById('timePicker');
    const elTimeStats = document.getElementById('timeStats');

    const elConfidenceBox = document.getElementById('confidenceBox');
    const elConfidenceHelp = document.getElementById('confidenceHelp');
    const elImproveBtn = document.getElementById('improveBtn');

    const elReplyCoach = document.getElementById('replyCoach');
    const elCopyBtn = document.getElementById('copyBtn');

    // ===== Storage =====
    const STORE_CHAT_KEY  = "chat_history_free_v1";
    const STORE_REPLY_KEY = "her_reply_times_free_v1";

    // ===== State =====
    let pendingTimes = [];            // æœ€æ–°æˆªåœ–æŠ“åˆ°çš„æ™‚é–“ï¼ˆå»å™ªå¾Œï¼‰
    let picked = [];                  // æ‰‹å‹•é»é¸ï¼šä½ ç™¼/å¥¹å›
    let latestHerReplyMinutes = null; // æ‰‹å‹•ä¿®æ­£å€¼ï¼ˆæœ‰å°±è¦†è“‹è‡ªå‹•ï¼‰
    let lastRawTimes = [];            // ç•™è‘—åˆ‡æ›æ¨¡å¼æ™‚å¯é‡æ–°éæ¿¾ï¼ˆè§£ Cï¼‰

    // ===== Helpers =====
    function setStatus(msg){
      elStatusBox.style.display = 'block';
      elStatusBox.textContent = msg;
    }
    function clearStatus(){
      elStatusBox.style.display = 'none';
      elStatusBox.textContent = "";
    }
    function loadJSON(key, fallback){
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }
    function loadChatHistory(){ return loadJSON(STORE_CHAT_KEY, []); }
    function saveChatHistory(items){ saveJSON(STORE_CHAT_KEY, items); }
    function appendChatHistory(item){
      const items = loadChatHistory();
      items.push(item);
      saveChatHistory(items);
      return items;
    }
    function loadReplyHistory(){ return loadJSON(STORE_REPLY_KEY, []); }
    function saveReplyHistory(items){ saveJSON(STORE_REPLY_KEY, items); }
    function appendReplyHistory(item){
      const items = loadReplyHistory();
      items.push(item);
      saveReplyHistory(items);
      return items;
    }

    function renderHistory(){
      const items = loadChatHistory();
      const replies = loadReplyHistory();

      if(!items.length){
        elHistoryBox.textContent = "ç›®å‰æ²’æœ‰å°è©±ç´€éŒ„ã€‚ä¸Šå‚³æˆªåœ–å¾Œï¼Œæˆ‘æœƒæŠŠæ¯æ¬¡ OCR çš„æ–‡å­—å­˜åœ¨æœ¬æ©Ÿã€‚";
      } else {
        const last = items[items.length-1];
        elHistoryBox.innerHTML =
          `å·²ç´¯ç©å°è©±ï¼š<b>${items.length}</b> æ¬¡<br>` +
          `æœ€è¿‘ä¸€æ¬¡ï¼š${new Date(last.ts).toLocaleString()}<br>` +
          `æœ€è¿‘æ‘˜è¦ï¼š<br><span style="opacity:.92;white-space:pre-wrap">${(last.text||"").slice(0,180)}</span>`;
      }

      if(replies.length){
        elTimeStats.textContent = buildReplyStatsText(replies);
      } else {
        if(!elTimeStats.textContent) elTimeStats.textContent = "";
      }
    }

    // iPhone çœè¨˜æ†¶é«”ï¼šç¸®åœ–
    async function downscaleToDataURL(file, maxSide=1400, quality=0.88){
      const img = new Image();
      const dataUrl = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
      await new Promise((res, rej) => {
        img.onload = res; img.onerror = rej; img.src = dataUrl;
      });

      const w = img.naturalWidth, h = img.naturalHeight;
      const scale = Math.min(1, maxSide / Math.max(w, h));
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      return canvas.toDataURL('image/jpeg', quality);
    }

    // OCRï¼šç¹ä¸­
    async function runOCR(imageDataUrl){
      const worker = await Tesseract.createWorker('chi_tra', 1, {
        logger: m => {
          if (m.status && typeof m.progress === 'number') {
            const p = Math.round(m.progress * 100);
            setStatus(`ğŸ” OCR è®€åœ–ä¸­â€¦ ${m.status}ï¼ˆ${p}%ï¼‰`);
          }
        }
      });
      try{
        await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK });
        const { data } = await worker.recognize(imageDataUrl);
        return (data.text || "")
          .replace(/[ \t]+\n/g, "\n")
          .replace(/\n{3,}/g, "\n\n")
          .trim();
      } finally {
        await worker.terminate();
      }
    }

    // ===== Time parsing / filtering (è§£ B/C) =====
    function extractTimesHHMM(text){
      // æ”¯æ´ï¼š9:05 / 09:05 / 9ï¼š05 / ä¸Šåˆ9:05 / ä¸‹åˆ 3:20 / 9:05 AM/PM
      const re = /(ä¸Šåˆ|ä¸‹åˆ)?\s*([0-9]{1,2})[ï¼š:]\s*([0-9]{2})(?:\s*(AM|PM))?/gi;
      const out = [];
      const seen = new Set();

      let m;
      while((m = re.exec(text)) !== null){
        let h = parseInt(m[2], 10);
        const min = m[3];
        const apCN = m[1];
        const apEN = m[4];

        if(apCN === "ä¸‹åˆ" && h < 12) h += 12;
        if(apCN === "ä¸Šåˆ" && h === 12) h = 0;

        if(apEN === "PM" && h < 12) h += 12;
        if(apEN === "AM" && h === 12) h = 0;

        const t = `${String(h).padStart(2,"0")}:${min}`;
        if(!seen.has(t)){
          seen.add(t);
          out.push(t);
        }
      }
      return out;
    }

    function toMinutes(hhmm){
      const [h,m] = hhmm.split(":").map(Number);
      return h*60+m;
    }
    function diffMinutes(a, b){
      let d = b-a;
      if(d < 0) d += 1440;
      return d;
    }

    function filterTimesByMode(times, mode){
      let out = times.slice();

      // æ›´å¼·å»å™ªï¼šåªç•™ã€Œåˆç†å°è©±ç¯€å¥ã€
      // < 2 åˆ†é˜ï¼šé€£ç™¼/é‡è¤‡ï¼›> 6 å°æ™‚ï¼šå¤šåŠéåŒæ®µ
      const keep = [];
      for(const t of out){
        if(!keep.length){ keep.push(t); continue; }
        const prev = keep[keep.length-1];
        const d = diffMinutes(toMinutes(prev), toMinutes(t));
        if(d >= 2 && d <= 360) keep.push(t);
      }
      out = keep;

      // IG å†åš´æ ¼ä¸€é»ï¼šè‹¥å¤ªå¤šå™ªéŸ³ï¼Œé™åˆ¶è·¨åº¦
      if(mode === "ig"){
        const igKeep = [];
        for(const t of out){
          if(!igKeep.length){ igKeep.push(t); continue; }
          const d = diffMinutes(toMinutes(igKeep[igKeep.length-1]), toMinutes(t));
          if(d <= 240) igKeep.push(t); // 4 å°æ™‚å…§ï¼ˆæ›´åƒåŒæ®µï¼‰
        }
        if(igKeep.length >= 2) out = igKeep;
      }

      // autoï¼šæ™‚é–“é»çˆ†å¤šå°±æ›´åš´æ ¼
      if(mode === "auto" && out.length >= 10){
        const autoKeep = [];
        for(const t of out){
          if(!autoKeep.length){ autoKeep.push(t); continue; }
          const d = diffMinutes(toMinutes(autoKeep[autoKeep.length-1]), toMinutes(t));
          if(d >= 3 && d <= 240) autoKeep.push(t); // 3 åˆ†ä»¥ä¸Šä¸” 4 å°æ™‚å…§
        }
        if(autoKeep.length >= 2) out = autoKeep;
      }

      return out;
    }

    // è‡ªå‹•æ¨å®šå›è¦†æ™‚é–“ï¼šå–ã€Œä¸­ä½æ•¸ã€é¿å…æ¥µç«¯å€¼
    function autoEstimateReplyMinutes(times){
      if(!times || times.length < 2) return null;

      const mins = times.map(toMinutes);
      const diffs = [];
      for(let i=0;i<mins.length-1;i++){
        const d = diffMinutes(mins[i], mins[i+1]);
        if(d >= 2 && d <= 360) diffs.push(d);
      }
      if(!diffs.length) return null;

      diffs.sort((a,b)=>a-b);
      const mid = diffs.length % 2
        ? diffs[(diffs.length-1)/2]
        : (diffs[diffs.length/2-1] + diffs[diffs.length/2]) / 2;
      return Math.round(mid);
    }

    // ===== Optional manual override time picker =====
    function renderTimePicker(times){
      elTimePicker.innerHTML = "";
      picked = [];
      latestHerReplyMinutes = null;

      if(times.length < 2){
        elTimeGuide.textContent = "âš ï¸ é€™å¼µæˆªåœ–æŠ“ä¸åˆ°è¶³å¤ æ™‚é–“ï¼ˆå°‘æ–¼ 2 å€‹ï¼‰ã€‚è‹¥è¦æ¨å®šå›è¦†æ™‚é–“ï¼Œè«‹è£œä¸€å¼µæœ‰é¡¯ç¤ºæ™‚é–“çš„æˆªåœ–ã€‚";
        return;
      }

      elTimeGuide.textContent = "ï¼ˆé¸å¡«ï¼‰ä½ è¦ºå¾—ä¸æº–å†é»ï¼šâ‘ ä½ ç™¼ â†’ â‘¡å¥¹å›ï¼ˆæœƒè¦†è“‹è‡ªå‹•æ¨å®šï¼‰";
      for(const t of times){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "timeBtn";
        b.textContent = t;
        b.dataset.t = t;
        b.addEventListener("click", () => onPickTime(b));
        elTimePicker.appendChild(b);
      }
    }

    function onPickTime(btn){
      const t = btn.dataset.t;
      if(picked.length >= 2) return;

      picked.push(t);
      btn.classList.add("picked");

      if(picked.length === 1){
        elTimeGuide.textContent = `å·²é¸ â‘  ä½ ç™¼ï¼š${picked[0]}ï¼Œå†é» â‘¡ å¥¹å›ä½ çš„æ™‚é–“`;
        return;
      }

      if(picked.length === 2){
        const myT = picked[0], herT = picked[1];
        const d = diffMinutes(toMinutes(myT), toMinutes(herT));
        latestHerReplyMinutes = d;

        const arr = appendReplyHistory({ ts: Date.now(), myTime: myT, herTime: herT, diff: d });
        elTimeStats.textContent = buildReplyStatsText(arr);
        renderTrendChart();

        elTimeGuide.textContent = `âœ… å·²æ‰‹å‹•ä¿®æ­£ï¼šå¥¹é€™æ¬¡å›ä½  ${d} åˆ†é˜ï¼ˆå·²è¨˜éŒ„ï¼‰`;
      }
    }

    document.getElementById("undoPickBtn").addEventListener("click", () => {
      if(!picked.length) return;
      const last = picked.pop();
      const btns = [...elTimePicker.querySelectorAll(".timeBtn")]
        .filter(b => b.dataset.t === last && b.classList.contains("picked"));
      if(btns.length) btns[btns.length-1].classList.remove("picked");

      latestHerReplyMinutes = null;
      if(picked.length === 0) elTimeGuide.textContent = "ï¼ˆé¸å¡«ï¼‰ä½ è¦ºå¾—ä¸æº–å†é»ï¼šâ‘ ä½ ç™¼ â†’ â‘¡å¥¹å›ï¼ˆæœƒè¦†è“‹è‡ªå‹•æ¨å®šï¼‰";
      if(picked.length === 1) elTimeGuide.textContent = `å·²é¸ â‘  ä½ ç™¼ï¼š${picked[0]}ï¼Œå†é» â‘¡ å¥¹å›ä½ çš„æ™‚é–“`;
    });

    document.getElementById("undoRecordBtn").addEventListener("click", () => {
      const arr = loadReplyHistory();
      if(!arr.length) return;
      arr.pop();
      saveReplyHistory(arr);

      elTimeStats.textContent = arr.length ? buildReplyStatsText(arr) : "";
      renderTrendChart();
      elTimeGuide.textContent = "å·²åˆªé™¤æœ€å¾Œä¸€æ¬¡å›è¦†ç´€éŒ„ã€‚";
    });

    function buildReplyStatsText(arr){
      const diffs = arr.map(x=>x.diff).slice().sort((a,b)=>a-b);
      const sum = diffs.reduce((s,x)=>s+x,0);
      const avg = sum / diffs.length;
      const median = diffs.length % 2
        ? diffs[(diffs.length-1)/2]
        : (diffs[diffs.length/2-1] + diffs[diffs.length/2]) / 2;
      const min = diffs[0], max = diffs[diffs.length-1];

      let trend = "";
      if(arr.length >= 3){
        const last3 = arr.slice(-3).map(x=>x.diff);
        const first = last3[0], last = last3[2];
        if(last - first >= 10) trend = "ï¼ˆæœ€è¿‘è®Šæ…¢ï¼‰";
        else if(first - last >= 10) trend = "ï¼ˆæœ€è¿‘è®Šå¿«ï¼‰";
        else trend = "ï¼ˆæœ€è¿‘å·®ä¸å¤šï¼‰";
      }

      return `â±ï¸ å¥¹å›è¦†çµ±è¨ˆï¼ˆç´¯ç© ${arr.length} æ¬¡ï¼‰
æœ€æ–°ï¼š${arr[arr.length-1].diff} åˆ†
å¹³å‡ï¼š${avg.toFixed(1)} åˆ†ï½œä¸­ä½æ•¸ï¼š${median} åˆ†ï½œæœ€çŸ­ï¼š${min} åˆ†ï½œæœ€é•·ï¼š${max} åˆ† ${trend}`;
    }

    function renderTrendChart(){
      const canvas = document.getElementById("trendChart");
      const ctx = canvas.getContext("2d");
      const arr = loadReplyHistory();
      const lastN = arr.slice(-7);
      const data = lastN.map(x=>x.diff);

      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(!data.length){
        ctx.fillStyle = "rgba(229,231,235,.75)";
        ctx.font = "14px system-ui";
        ctx.fillText("è¶¨å‹¢åœ–ï¼šå°šç„¡è³‡æ–™ï¼ˆå¯é¸å¡«æ‰‹å‹•ä¿®æ­£ä¸€æ¬¡ï¼‰", 14, 28);
        return;
      }

      const padL=42, padR=12, padT=18, padB=28;
      const W=canvas.width, H=canvas.height;
      const innerW=W-padL-padR, innerH=H-padT-padB;

      const maxV=Math.max(...data), minV=Math.min(...data);
      const span=Math.max(1, maxV-minV);

      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.beginPath();
      ctx.moveTo(padL,padT);
      ctx.lineTo(padL,H-padB);
      ctx.lineTo(W-padR,H-padB);
      ctx.stroke();

      ctx.fillStyle="rgba(229,231,235,.75)";
      ctx.font="12px system-ui";
      ctx.fillText(String(maxV), 8, padT+10);
      ctx.fillText(String(minV), 8, H-padB);

      const pts=data.map((v,i)=>{
        const x=padL+(data.length===1?innerW/2:(innerW*i/(data.length-1)));
        const y=padT+(innerH*(1-(v-minV)/span));
        return {x,y,v};
      });

      ctx.strokeStyle="rgba(56,189,248,.95)";
      ctx.lineWidth=2;
      ctx.beginPath();
      pts.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
      ctx.stroke();

      ctx.fillStyle="rgba(52,211,153,.95)";
      pts.forEach(p=>{
        ctx.beginPath(); ctx.arc(p.x,p.y,3.5,0,Math.PI*2); ctx.fill();
      });

      ctx.fillStyle="rgba(229,231,235,.85)";
      ctx.font="13px system-ui";
      ctx.fillText("æœ€è¿‘ 7 æ¬¡ï¼šå¥¹å›ä½ å¤šä¹…ï¼ˆåˆ†é˜ï¼‰", padL, 14);
    }

    // ===== Free reply coach: only 1 best sentence (è§£ D) =====
    function buildReplyCoach(label, replyMin){
      const isSlow = typeof replyMin === "number" && replyMin >= 120;
      const isVerySlow = typeof replyMin === "number" && replyMin >= 360;

      let text = "";
      let reason = "";

      if(label.includes("ğŸ”¥") || label.includes("å¾ˆç†±")){
        text = "ä½ ä»Šå¤©æˆ–æ˜å¤©å“ªå€‹æ¯”è¼ƒæœ‰ç©ºï¼Ÿæˆ‘æƒ³ç´„ä½ å–å€‹é£²æ–™ğŸ™‚";
        reason = "äº’å‹•åç†±ã€ç¯€å¥ç©©ï¼Œç¾åœ¨é©åˆæŠŠèŠå¤©æ¨é€²ä¸€æ­¥ã€‚";
      }
      else if(label.includes("ğŸŒ¤ï¸") || label.includes("æ›–æ˜§")){
        text = isSlow ? "ä½ å¿™æ²’é—œä¿‚ï½ä½ æœ‰ç©ºå†å›æˆ‘å°±å¥½ğŸ™‚" : "æˆ‘å…ˆå»å¿™ä¸€ä¸‹ï½ä½ æœ‰ç©ºå†å›å°±å¥½ğŸ™‚";
        reason = "äº’å‹•ä¸éŒ¯ä½†æœªæ˜ç¢ºï¼Œå…ˆä¿ç•™ç©ºé–“è§€å¯Ÿã€‚";
      }
      else if(label.includes("ğŸ§Š") || label.includes("åå†·")){
        text = isVerySlow ? "æˆ‘æ„Ÿè¦ºä½ æœ€è¿‘æ¯”è¼ƒå¿™ï¼Œé‚£æˆ‘å°±å…ˆä¸æ‰“æ“¾ä½ äº†ğŸ™‚" : "å¥½ï½é‚£ä½ å…ˆå¿™ğŸ™‚";
        reason = "äº’å‹•åå†·ï¼Œç¾åœ¨æ”¶æ‰‹æ˜¯æœ€ä¸å¾Œæ‚”çš„é¸æ“‡ã€‚";
      }
      else{
        text = "æˆ‘å…ˆå»å¿™ï½ä½ æœ‰ç©ºå†å›å°±å¥½ğŸ™‚";
        reason = "ç‹€æ³ä¸æ˜ï¼Œå…ˆç”¨ä½é¢¨éšªå›è¦†ä¿è­·è‡ªå·±ã€‚";
      }

      return { text, reason };
    }

    // ===== Core analysis =====
    function analyzeText(allText, replyMin){
      let score = 0;
      const t = allText || "";

      const HOT  = ["æƒ³ä½ ","æƒ³è¦‹ä½ ","æˆ‘æƒ³ä½ ","æŠ±æŠ±","è¦ªè¦ª","æ„›ä½ ","å–œæ­¡ä½ ","å¯¶","å¯¶è²","â¤ï¸","ğŸ˜˜","ğŸ˜","æ™šå®‰â¤ï¸","æƒ³ä½ äº†"];
      const WARM = ["å“ˆå“ˆ","ç¬‘æ­»","æ¬¸","åœ¨å—","ä½ åœ¨å¹¹å˜›","å¹¹å˜›","å¯ä»¥å•Š","å¥½å‘€","OK","è¡Œ","æ™šå®‰","æ—©å®‰","åƒé£¯","å‡ºå»","ä¸‹æ¬¡","æ”¹å¤©"];
      const COLD = ["å—¯","å–”","å“¦","å¥½","éš¨ä¾¿","ä¸çŸ¥é“","å†èªª","å¿™","å…ˆé€™æ¨£","æ°","å‘µ","å·²è®€","å·²è®€ä¸å›","å›å¾ˆæ…¢","æ•·è¡","ä¸å›","éƒ½æˆ‘ä¸»å‹•"];

      HOT.forEach(w => { if(t.includes(w)) score += 2; });
      WARM.forEach(w => { if(t.includes(w)) score += 1; });
      COLD.forEach(w => { if(t.includes(w)) score -= 1; });

      if (t.replace(/\s/g,"").length <= 2) score -= 1;
      ["å·²è®€ä¸å›","å›å¾ˆæ…¢","éƒ½æˆ‘ä¸»å‹•"].forEach(w => { if(t.includes(w)) score -= 2; });

      if(typeof replyMin === "number"){
        if(replyMin <= 10) score += 3;
        else if(replyMin <= 30) score += 2;
        else if(replyMin <= 60) score += 1;
        else if(replyMin <= 180) score -= 1;
        else score -= 2;
      }

      let label = "ğŸ˜ æ™®é€š";
      let advice = "å»ºè­°ï¼šç”¨ä¸€æ¬¡è¼•é‡é‚€ç´„æ¸¬å¥¹æœƒä¸æœƒæŠŠæ™‚é–“çµ¦ä½ ï¼ˆæ¯”ä¸€ç›´èŠå¤©æ›´æº–ï¼‰ã€‚";

      if(score >= 6){
        label = "ğŸ”¥ å¾ˆç†±";
        advice = "è¶ç†±æŠŠé‚€ç´„è½åœ°ï¼šçµ¦ã€æ™‚é–“ + åœ°é» + ä¸€å€‹é¸é …ã€ï¼Œä¸è¦é€£ç™¼è¿½å•ã€‚";
      } else if(score >= 3){
        label = "ğŸŒ¤ï¸ æ›–æ˜§";
        advice = "ç¶­æŒç¯€å¥ï¼šçŸ­å¥ã€æœ‰æ”¶å°¾ï¼›ç”¨ä¸€æ¬¡é‚€ç´„æ¸¬å¥¹é¡˜ä¸é¡˜æ„æŠŠäº’å‹•æ¨åˆ°ç¾å¯¦ã€‚";
      } else if(score <= 0){
        label = "ğŸ§Š åå†·";
        advice = "å…ˆé™é »ï¼Œä¸é€£ç™¼ï¼›å†ç”¨ä¸€æ¬¡ä¸å£“è¿«é‚€ç´„åšåˆ†æ°´å¶ºï¼Œæ²’æ¥çƒå°±åœ 3 å¤©ã€‚";
      }

      return { score, label, advice };
    }

    // ===== Confidence =====
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function computeConfidence({ historyCount, replySource, timeCount, scoreAbs }){
      let c = 0;

      // è³‡æ–™é‡ 0~35
      const vol = clamp(10 + Math.log2(Math.max(1, historyCount)) * 10, 8, 35);
      c += vol;

      // å›è¦†æ™‚é–“å¯é åº¦ 0~35
      let rt = 0;
      if(replySource === "manual") rt += 28;
      else if(replySource === "auto") rt += 20;
      else rt += 8;

      if(timeCount >= 6) rt += 7;
      else if(timeCount >= 2) rt += 3;
      else rt -= 6;

      // æ™‚é–“é»å¤ªå¤š = å™ªéŸ³
      if(timeCount >= 18) rt -= 18;
      else if(timeCount >= 12) rt -= 10;
      else if(timeCount >= 8) rt -= 5;

      rt = clamp(rt, 0, 35);
      c += rt;

      // è¨Šè™Ÿå¼·åº¦ 0~30
      let sig = 8;
      if(scoreAbs >= 6) sig = 28;
      else if(scoreAbs >= 3) sig = 18;
      c += sig;

      c = clamp(Math.round(c), 0, 100);
      return { value: c };
    }

    function buildConfidenceOneLiner(conf, replySource, timeCount){
      if(conf.value >= 75){
        return `ä¿¡å¿ƒ ${conf.value}%ï¼šè³‡æ–™å¤ ã€å›è¦†ç¯€å¥ç©©ï¼Œåˆ¤æ–·å¯ä¿¡`;
      }
      if(conf.value >= 55){
        if(replySource === "none") return `ä¿¡å¿ƒ ${conf.value}%ï¼šç¼ºå°‘å›è¦†æ™‚é–“ï¼Œçµæœåƒ…ä¾›åƒè€ƒ`;
        return `ä¿¡å¿ƒ ${conf.value}%ï¼šè¨Šè™Ÿåä¸­é–“ï¼Œå»ºè­°ç”¨ä¸€æ¬¡é‚€ç´„é©—è­‰`;
      }
      if(timeCount < 2){
        return `ä¿¡å¿ƒ ${conf.value}%ï¼šæ™‚é–“è³‡è¨Šä¸è¶³ï¼Œå»ºè­°è£œä¸€å¼µæœ‰æ™‚é–“çš„æˆªåœ–`;
      }
      return `ä¿¡å¿ƒ ${conf.value}%ï¼šè¨Šè™Ÿæ··é›œï¼Œå…ˆåˆ¥å¤ªæŠ•å…¥ï¼Œè§€å¯Ÿå³å¯`;
    }

    function buildConfidenceHelp(conf, timeCount, hasReplyMin){
      const tips = [];
      let action = "none";

      if(conf.value < 55){
        if(timeCount < 2){
          tips.push("è£œä¸€å¼µã€æœ‰é¡¯ç¤ºæ™‚é–“ã€çš„æˆªåœ–ï¼ˆä¾‹å¦‚ 09:59ã€10:23ï¼‰ã€‚");
          tips.push("æˆªåœ–è£åˆ‡åªç•™å°è©±å€ï¼ˆä¸è¦ç‹€æ…‹åˆ—/éµç›¤ï¼‰ï¼ŒOCR æœƒæ›´æº–ã€‚");
          action = "upload";
        } else if(!hasReplyMin){
          tips.push("é¸å¡«ï¼šé»ã€ä½ ç™¼â†’å¥¹å›ã€å…©å€‹æ™‚é–“ï¼Œå¯å¤§å¹…æå‡å›è¦†æ™‚é–“æº–ç¢ºåº¦ã€‚");
          tips.push("é¸ã€ä½ æœ€å¾Œä¸€å‰‡ã€â†’ã€å¥¹ç¬¬ä¸€å‰‡å›ã€ï¼Œä¸è¦é¸åŒä¸€é‚Šé€£ç™¼ã€‚");
          action = "pick_time";
        } else {
          tips.push("å†è£œ 1 å¼µã€æœ€æ–°ä¸€æ®µã€æˆªåœ–ï¼Œè®“ç³»çµ±çœ‹åˆ°è¶¨å‹¢ã€‚");
          tips.push("å¦‚æœå…§å®¹å¾ˆçŸ­ï¼ˆåªæœ‰å—¯/å¥½ï¼‰ï¼Œå»ºè­°å¤šæˆªä¸€é»ä¸Šä¸‹æ–‡ã€‚");
          action = "upload";
        }
      } else if(conf.value < 75){
        if(timeCount >= 2 && !hasReplyMin){
          tips.push("è‹¥ä½ æƒ³æ›´æº–ï¼šé¸å¡«æ‰‹å‹•é»ã€ä½ ç™¼â†’å¥¹å›ã€å…©å€‹æ™‚é–“ã€‚");
          action = "pick_time";
        } else {
          tips.push("ç”¨ä¸€æ¬¡è¼•é‡é‚€ç´„åšé©—è­‰ï¼ˆæ¯”ä¸€ç›´èŠå¤©æ›´èƒ½ç¢ºèªæ–¹å‘ï¼‰ã€‚");
          action = "none";
        }
      } else {
        tips.push("ç›®å‰ä¿¡å¿ƒå·²é«˜ï¼šç…§å»ºè­°åšä¸€æ¬¡é‚€ç´„/æ”¶å°¾ï¼Œå°±èƒ½å¿«é€Ÿé©—è­‰ã€‚");
        action = "none";
      }

      return { tips, action };
    }

    // ===== Events =====
    elImage.addEventListener('change', async () => {
      const files = Array.from(elImage.files || []);
      if(!files.length) return;

      clearStatus();
      elResult.textContent = "";
      elHint.textContent = "";

      elConfidenceBox.style.display = "none";
      elConfidenceHelp.style.display = "none";
      elImproveBtn.style.display = "none";

      elReplyCoach.style.display = "none";
      elCopyBtn.style.display = "none";

      picked = [];
      latestHerReplyMinutes = null;
      pendingTimes = [];
      lastRawTimes = [];
      elTimePicker.innerHTML = "";

      for(let i=0;i<files.length;i++){
        setStatus(`ğŸ–¼ï¸ ç¬¬ ${i+1}/${files.length} å¼µï¼šç¸®åœ–ä¸­â€¦`);
        const dataUrl = await downscaleToDataURL(files[i], 1400, 0.88);

        if(i === files.length - 1){
          elPreview.src = dataUrl;
          elPreviewWrap.style.display = "block";
        }

        try{
          setStatus(`ğŸ” ç¬¬ ${i+1}/${files.length} å¼µï¼šOCR è®€åœ–ä¸­â€¦`);
          const text = await runOCR(dataUrl);
          const clean = (text || "").trim();
          if(!clean){
            setStatus(`âš ï¸ ç¬¬ ${i+1}/${files.length} å¼µï¼šæ²’è¾¨è­˜åˆ°æ–‡å­—ï¼ˆç•¥éï¼‰ã€‚`);
            continue;
          }

          appendChatHistory({ ts: Date.now(), text: clean });
          elChat.value = clean;
          renderHistory();

          if(i === files.length - 1){
            lastRawTimes = extractTimesHHMM(clean);
            const mode = elAppMode.value;
            pendingTimes = filterTimesByMode(lastRawTimes, mode);

            renderTimePicker(pendingTimes);

            const autoMin = autoEstimateReplyMinutes(pendingTimes);
            if(typeof autoMin === "number"){
              elTimeGuide.textContent = `âœ… ç³»çµ±è‡ªå‹•æ¨å®šï¼šå¥¹å¤§ç´„ ${autoMin} åˆ†é˜å›ä½ ï¼ˆé¸å¡«ï¼šæ‰‹å‹•é»ä½ ç™¼â†’å¥¹å›å¯æ›´æº–ï¼‰`;
            } else {
              elTimeGuide.textContent = "âš ï¸ ç³»çµ±ç„¡æ³•è‡ªå‹•æ¨å®šå›è¦†æ™‚é–“ï¼ˆæ™‚é–“å¤ªå°‘æˆ–å¤ªäº‚ï¼‰ã€‚å»ºè­°è£œä¸€å¼µæœ‰æ™‚é–“çš„æˆªåœ–ã€‚";
            }
          }

          setStatus(`âœ… ç¬¬ ${i+1}/${files.length} å¼µï¼šå®Œæˆï¼ˆå·²å­˜æœ¬æ©Ÿï¼‰ã€‚`);
        } catch(e){
          console.error(e);
          setStatus(`âŒ ç¬¬ ${i+1}/${files.length} å¼µï¼šOCR å¤±æ•—ï¼ˆç•¥éï¼‰ã€‚`);
        }
      }

      renderTrendChart();
      setStatus("âœ… å…¨éƒ¨è™•ç†å®Œæˆï¼šä½ å¯ä»¥æŒ‰ã€Œé–‹å§‹åˆ†æã€ã€‚");
    });

    // åˆ‡æ› LINE/IG/è‡ªå‹•ï¼šé‡æ–°éæ¿¾ï¼ˆè§£ Cï¼‰
    elAppMode.addEventListener("change", () => {
      if(!lastRawTimes || !lastRawTimes.length){
        elTimeGuide.textContent = "è«‹å…ˆä¸Šå‚³ä¸€å¼µæœ‰é¡¯ç¤ºæ™‚é–“çš„æˆªåœ–ã€‚";
        return;
      }
      const mode = elAppMode.value;
      pendingTimes = filterTimesByMode(lastRawTimes, mode);
      renderTimePicker(pendingTimes);

      const autoMin = autoEstimateReplyMinutes(pendingTimes);
      if(typeof autoMin === "number"){
        elTimeGuide.textContent = `âœ…ï¼ˆ${mode}ï¼‰ç³»çµ±è‡ªå‹•æ¨å®šï¼šå¥¹å¤§ç´„ ${autoMin} åˆ†é˜å›ä½ ï¼ˆé¸å¡«æ‰‹å‹•å¯æ›´æº–ï¼‰`;
      } else {
        elTimeGuide.textContent = `âš ï¸ï¼ˆ${mode}ï¼‰ä»ç„¡æ³•è‡ªå‹•æ¨å®šï¼ˆæ™‚é–“å¤ªå°‘/å¤ªäº‚ï¼‰ï¼Œå»ºè­°è£œæˆªåœ–ã€‚`;
      }
    });

    elAnalyzeBtn.addEventListener('click', () => {
      const typed = (elChat.value || "").trim();
      const history = loadChatHistory();
      const allText = history.map(x => x.text).join("\n\n---\n\n");
      const textForAnalysis = (allText + (typed ? ("\n\n[æœ€æ–°è£œå……]\n" + typed) : "")).trim();

      if(!textForAnalysis){
        elResult.textContent = "âš ï¸ æ²’æœ‰å¯åˆ†æçš„æ–‡å­—";
        elHint.textContent = "å…ˆä¸Šå‚³æˆªåœ–æˆ–è²¼å¹¾å¥æ–‡å­—ã€‚";
        return;
      }

      // å›è¦†æ™‚é–“ï¼šæ‰‹å‹•è¦†è“‹å„ªå…ˆï¼›å¦å‰‡è‡ªå‹•æ¨å®š
      let replyMin = latestHerReplyMinutes;
      let replySource = "none";
      if(typeof replyMin === "number"){
        replySource = "manual";
      } else {
        const autoMin = autoEstimateReplyMinutes(pendingTimes);
        if(typeof autoMin === "number"){
          replyMin = autoMin;
          replySource = "auto";
        }
      }

      clearStatus();

      const { score, label, advice } = analyzeText(textForAnalysis, replyMin);
      const historyCount = history.length;
      const timeCount = (pendingTimes || []).length;

      // é¡¯ç¤ºçµæœ
      const replyText =
        (typeof replyMin === "number")
          ? (replySource === "manual" ? `å¥¹å›ä½  ${replyMin} åˆ†ï¼ˆæ‰‹å‹•ä¿®æ­£ï¼‰` : `å¥¹ç´„ ${replyMin} åˆ†å›ï¼ˆè‡ªå‹•æ¨å®šï¼‰`)
          : "å›è¦†æ™‚é–“ï¼šæœªçŸ¥";

      elResult.textContent = `${label}ï¼ˆç´¯ç© ${historyCount} æ¬¡ï½œ${replyText}ï¼‰`;
      elHint.textContent = advice;

      // ä¿¡å¿ƒæŒ‡æ•¸
      const conf = computeConfidence({
        historyCount,
        replySource,
        timeCount,
        scoreAbs: Math.abs(score)
      });

      const oneLine = buildConfidenceOneLiner(conf, replySource, timeCount);
      elConfidenceBox.style.display = "block";
      elConfidenceBox.innerHTML = `<b>${oneLine}</b>`;

      // ä¸€éµæå‡ä¿¡å¿ƒ
      const hasReplyMin = (typeof replyMin === "number");
      const help = buildConfidenceHelp(conf, timeCount, hasReplyMin);

      elConfidenceHelp.style.display = "block";
      elConfidenceHelp.textContent = "æå‡ä¿¡å¿ƒçš„æ–¹æ³•ï¼š\n- " + help.tips.join("\n- ");

      elImproveBtn.style.display = (help.action === "none") ? "none" : "block";
      elImproveBtn.textContent = help.action === "pick_time" ? "å»é»é¸æ™‚é–“ï¼ˆä½ â†’å¥¹ï¼‰" : "å†ä¸Šå‚³ä¸€å¼µæˆªåœ–";
      elImproveBtn.onclick = () => {
        if(help.action === "pick_time"){
          document.getElementById("timeGuide").scrollIntoView({ behavior:"smooth", block:"center" });
          elTimeGuide.textContent = "é¸å¡«ï¼šè«‹ä¾åºé» â‘ ä½ æœ€å¾Œä¸€å‰‡ç™¼å‡ºå»çš„æ™‚é–“ â†’ â‘¡å¥¹ç¬¬ä¸€å‰‡å›è¦†çš„æ™‚é–“ï¼ˆæœƒæ›´æº–ï¼‰";
        } else if(help.action === "upload"){
          elImage.click();
        }
      };

      // å›è¦†æ•™ç·´ï¼ˆæ¥µç°¡ä¸€å¥ï¼‰
      const coach = buildReplyCoach(label, replyMin);
      elReplyCoach.style.display = "block";
      elReplyCoach.innerHTML =
        `<b>ç¾åœ¨æœ€å»ºè­°ä½ é€™æ¨£å›ï¼š</b><br><br>` +
        `ã€Œ${coach.text}ã€<br><br>` +
        `<span style="opacity:.88">åŸå› ï¼š${coach.reason}</span>`;

      elCopyBtn.style.display = "block";
      elCopyBtn.textContent = "è¤‡è£½é€™ä¸€å¥å»å›";
      elCopyBtn.onclick = async () => {
        try{
          await navigator.clipboard.writeText(coach.text);
          elCopyBtn.textContent = "âœ… å·²è¤‡è£½";
          setTimeout(()=> elCopyBtn.textContent = "è¤‡è£½é€™ä¸€å¥å»å›", 1200);
        } catch(e){
          alert("è¤‡è£½å¤±æ•—ï¼šè«‹é•·æŒ‰æ‰‹å‹•è¤‡è£½ã€‚");
        }
      };
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem(STORE_CHAT_KEY);
      localStorage.removeItem(STORE_REPLY_KEY);

      elChat.value = "";
      elPreviewWrap.style.display = "none";
      elPreview.src = "";

      pendingTimes = [];
      lastRawTimes = [];
      picked = [];
      latestHerReplyMinutes = null;

      elTimePicker.innerHTML = "";
      elTimeGuide.textContent = "å·²æ¸…é™¤ã€‚è«‹é‡æ–°ä¸Šå‚³æˆªåœ–ã€‚";
      elTimeStats.textContent = "";

      elResult.textContent = "";
      elHint.textContent = "";

      elConfidenceBox.style.display = "none";
      elConfidenceHelp.style.display = "none";
      elImproveBtn.style.display = "none";

      elReplyCoach.style.display = "none";
      elCopyBtn.style.display = "none";

      clearStatus();
      renderHistory();
      renderTrendChart();
      setStatus("ğŸ§¹ å·²æ¸…é™¤æœ¬æ©Ÿå°è©±èˆ‡å›è¦†ç´€éŒ„ã€‚");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const payload = {
        chatHistory: loadChatHistory(),
        replyHistory: loadReplyHistory()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat_history_export.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // init
    renderHistory();
    renderTrendChart();
  </script>
</body>
</html>
